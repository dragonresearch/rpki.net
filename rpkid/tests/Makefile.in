# $Id$

PYTHON = @PYTHON@
abs_top_builddir = @abs_top_builddir@

all: protocol-samples

clean:
	rm -rf smoketest.dir left-right-protocol-samples publication-protocol-samples yamltest.dir yamlconf.dir rcynic.xml rcynic-data

protocol-samples: left-right-protocol-samples/.stamp publication-protocol-samples/.stamp

left-right-protocol-samples/.stamp: left-right-protocol-samples.xml split-protocol-samples.xsl 
	rm -rf left-right-protocol-samples
	mkdir  left-right-protocol-samples
	xsltproc --param verbose 0 --stringparam dir left-right-protocol-samples split-protocol-samples.xsl left-right-protocol-samples.xml
	touch $@

publication-protocol-samples/.stamp: publication-protocol-samples.xml split-protocol-samples.xsl 
	rm -rf publication-protocol-samples
	mkdir  publication-protocol-samples
	xsltproc --param verbose 0 --stringparam dir publication-protocol-samples split-protocol-samples.xsl publication-protocol-samples.xml
	touch $@

parse-test: protocol-samples
	${PYTHON} xml-parse-test.py

all-tests:: parse-test

all-tests:: 
	${PYTHON} smoketest.py -y smoketest.1.yaml

all-tests::
	${PYTHON} smoketest.py -y smoketest.2.yaml

test all-tests::
	${PYTHON} smoketest.py -y smoketest.3.yaml

all-tests::
	${PYTHON} smoketest.py -y smoketest.4.yaml

all-tests::
	${PYTHON} smoketest.py -y smoketest.5.yaml

test all-tests::
	${PYTHON} smoketest.py -y smoketest.6.yaml

all-tests::
	${PYTHON} smoketest.py -y smoketest.7.yaml

profile: all
	find smoketest.dir -name '*.prof' -delete
	${PYTHON} smoketest.py -y smoketest.2.yaml -p
	for i in smoketest.dir/*.prof; do ${PYTHON} -c "import pstats;pstats.Stats('$$i').sort_stats('time').print_stats()"; done

# This isn't a full exercise of the yamltest framework, but is
# probably as good as we can do under make.

YAMLTEST_CONFIG = smoketest.1.yaml

yamltest:
	rm -rf yamltest.dir rcynic-data
	${PYTHON} sql-cleaner.py
	${PYTHON} yamltest.py ${YAMLTEST_CONFIG}

YAMLCONF_CONFIG = smoketest.1.yaml

yamlconf:
	rm -rf yamlconf.dir rcynic-data
	${PYTHON} sql-cleaner.py
	${PYTHON} yamlconf.py ${YAMLCONF_CONFIG}

backup:
	${PYTHON} sql-dumper.py
	tar cvvzf yamltest.backup.$$(TZ='' date +%Y.%m.%d.%H.%M.%S).tgz screenlog.* yamltest.dir backup.*.sql
	rm backup.*.sql

distclean: clean
	rm -f rcynic.xml Makefile
